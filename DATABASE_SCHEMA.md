# Database Schema - IBM i Query Runner

## Overview
This document defines the complete database schema for the IBM i Query Runner application. The schema is designed to be library-agnostic, allowing users to deploy to any library of their choice.

## Deployment Instructions

1. Create your library (or use existing):
   ```sql
   CRTLIB LIB(YOURLIB) TEXT('Query Runner Application')
   ```

2. Set the schema before running DDL:
   ```sql
   SET SCHEMA YOURLIB;
   ```

3. Run all CREATE statements in this document

## Schema Design Principles

1. **Query Sets as Primary Organization**: All queries belong to a query set
2. **Audit Trail**: Track creation, modification, and refresh operations
3. **Flexible Metrics**: Support multiple levels of performance data collection
4. **Historical Data**: Preserve execution history for trend analysis
5. **Referential Integrity**: Use foreign keys to maintain data consistency
6. **Library Agnostic**: No hard-coded library names in DDL

## Table Definitions

### QRYRUN_USERS
Stores authorized users who can access the application.

```sql
CREATE TABLE QRYRUN_USERS (
    USER_ID VARCHAR(10) NOT NULL PRIMARY KEY,
    USER_NAME VARCHAR(50),
    EMAIL VARCHAR(100),
    IS_ADMIN CHAR(1) DEFAULT 'N' NOT NULL,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    LAST_LOGIN TIMESTAMP,
    CONSTRAINT CHK_USERS_ADMIN CHECK (IS_ADMIN IN ('Y', 'N'))
);

LABEL ON TABLE QRYRUN_USERS IS 'Authorized Application Users';
LABEL ON COLUMN QRYRUN_USERS.USER_ID IS 'IBM i User Profile';
LABEL ON COLUMN QRYRUN_USERS.USER_NAME IS 'Full Name';
LABEL ON COLUMN QRYRUN_USERS.EMAIL IS 'Email Address';
LABEL ON COLUMN QRYRUN_USERS.IS_ADMIN IS 'Admin Flag (Y/N)';
LABEL ON COLUMN QRYRUN_USERS.CREATED_AT IS 'Account Created';
LABEL ON COLUMN QRYRUN_USERS.LAST_LOGIN IS 'Last Login Time';

CREATE INDEX USERS_LOGIN_IDX ON QRYRUN_USERS(USER_ID, IS_ADMIN);

-- Initial data: Grant QSECOFR access by default
INSERT INTO QRYRUN_USERS (USER_ID, USER_NAME, IS_ADMIN)
VALUES ('QSECOFR', 'Security Officer', 'Y');
```

### QRYRUN_QUERY_SETS
Stores query set definitions and metadata.

```sql
CREATE TABLE QRYRUN_QUERY_SETS (
    SET_ID INTEGER NOT NULL GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    SET_NAME VARCHAR(100) NOT NULL,
    SET_DESCRIPTION VARCHAR(500),
    SOURCE_USER_PROFILE VARCHAR(10) NOT NULL,
    IMPORT_DATE_FROM DATE,
    IMPORT_DATE_TO DATE,
    PLAN_CACHE_VIEW VARCHAR(50) NOT NULL,
    ADDITIONAL_FILTERS VARCHAR(1000),
    CREATED_BY VARCHAR(10) NOT NULL,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    LAST_REFRESHED TIMESTAMP,
    IS_ACTIVE CHAR(1) DEFAULT 'Y' NOT NULL,
    QUERY_COUNT INTEGER DEFAULT 0 NOT NULL,
    CONSTRAINT FK_QSET_CREATED_BY FOREIGN KEY (CREATED_BY) 
        REFERENCES QRYRUN_USERS(USER_ID),
    CONSTRAINT CHK_QSET_ACTIVE CHECK (IS_ACTIVE IN ('Y', 'N')),
    CONSTRAINT CHK_QSET_VIEW CHECK (PLAN_CACHE_VIEW IN ('PLAN_CACHE_INFO', 'PLAN_CACHE'))
);

LABEL ON TABLE QRYRUN_QUERY_SETS IS 'Query Set Definitions';
LABEL ON COLUMN QRYRUN_QUERY_SETS.SET_ID IS 'Query Set ID';
LABEL ON COLUMN QRYRUN_QUERY_SETS.SET_NAME IS 'Query Set Name';
LABEL ON COLUMN QRYRUN_QUERY_SETS.SET_DESCRIPTION IS 'Description';
LABEL ON COLUMN QRYRUN_QUERY_SETS.SOURCE_USER_PROFILE IS 'User Profile Filter';
LABEL ON COLUMN QRYRUN_QUERY_SETS.IMPORT_DATE_FROM IS 'Import Start Date';
LABEL ON COLUMN QRYRUN_QUERY_SETS.IMPORT_DATE_TO IS 'Import End Date';
LABEL ON COLUMN QRYRUN_QUERY_SETS.PLAN_CACHE_VIEW IS 'Plan Cache View Used';
LABEL ON COLUMN QRYRUN_QUERY_SETS.ADDITIONAL_FILTERS IS 'Additional Filters (JSON)';
LABEL ON COLUMN QRYRUN_QUERY_SETS.CREATED_BY IS 'Created By User';
LABEL ON COLUMN QRYRUN_QUERY_SETS.CREATED_AT IS 'Created Timestamp';
LABEL ON COLUMN QRYRUN_QUERY_SETS.LAST_REFRESHED IS 'Last Refresh Time';
LABEL ON COLUMN QRYRUN_QUERY_SETS.IS_ACTIVE IS 'Active Flag';
LABEL ON COLUMN QRYRUN_QUERY_SETS.QUERY_COUNT IS 'Number of Queries';

CREATE INDEX QSET_ACTIVE_IDX ON QRYRUN_QUERY_SETS(IS_ACTIVE, CREATED_AT);
CREATE INDEX QSET_USER_IDX ON QRYRUN_QUERY_SETS(SOURCE_USER_PROFILE);
```

### QRYRUN_QUERIES
Stores individual queries within query sets.

```sql
CREATE TABLE QRYRUN_QUERIES (
    QUERY_ID INTEGER NOT NULL GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    SET_ID INTEGER NOT NULL,
    QUERY_TEXT CLOB(10M) NOT NULL,
    QUERY_NAME VARCHAR(100),
    QUERY_HASH VARCHAR(64) NOT NULL,
    SOURCE_USER VARCHAR(10),
    PLAN_CACHE_KEY VARCHAR(100),
    ADDED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    LAST_SEEN_IN_CACHE TIMESTAMP,
    IS_ACTIVE CHAR(1) DEFAULT 'Y' NOT NULL,
    SEQUENCE_NUM INTEGER NOT NULL,
    CONSTRAINT FK_QUERY_SET FOREIGN KEY (SET_ID) 
        REFERENCES QRYRUN_QUERY_SETS(SET_ID) ON DELETE CASCADE,
    CONSTRAINT CHK_QUERY_ACTIVE CHECK (IS_ACTIVE IN ('Y', 'N'))
);

LABEL ON TABLE QRYRUN_QUERIES IS 'Queries in Query Sets';
LABEL ON COLUMN QRYRUN_QUERIES.QUERY_ID IS 'Query ID';
LABEL ON COLUMN QRYRUN_QUERIES.SET_ID IS 'Parent Query Set';
LABEL ON COLUMN QRYRUN_QUERIES.QUERY_TEXT IS 'SQL Query Text';
LABEL ON COLUMN QRYRUN_QUERIES.QUERY_NAME IS 'Query Name';
LABEL ON COLUMN QRYRUN_QUERIES.QUERY_HASH IS 'Query Hash for Dedup';
LABEL ON COLUMN QRYRUN_QUERIES.SOURCE_USER IS 'Original User';
LABEL ON COLUMN QRYRUN_QUERIES.PLAN_CACHE_KEY IS 'Plan Cache Key';
LABEL ON COLUMN QRYRUN_QUERIES.ADDED_AT IS 'Added to Set';
LABEL ON COLUMN QRYRUN_QUERIES.LAST_SEEN_IN_CACHE IS 'Last Seen in Cache';
LABEL ON COLUMN QRYRUN_QUERIES.IS_ACTIVE IS 'Active Flag';
LABEL ON COLUMN QRYRUN_QUERIES.SEQUENCE_NUM IS 'Sequence in Set';

CREATE INDEX QUERY_SET_IDX ON QRYRUN_QUERIES(SET_ID, IS_ACTIVE, SEQUENCE_NUM);
CREATE INDEX QUERY_HASH_IDX ON QRYRUN_QUERIES(SET_ID, QUERY_HASH);
CREATE INDEX QUERY_CACHE_KEY_IDX ON QRYRUN_QUERIES(PLAN_CACHE_KEY);
```

### QRYRUN_SET_REFRESH_LOG
Tracks refresh operations on query sets.

```sql
CREATE TABLE QRYRUN_SET_REFRESH_LOG (
    REFRESH_ID INTEGER NOT NULL GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    SET_ID INTEGER NOT NULL,
    REFRESHED_BY VARCHAR(10) NOT NULL,
    REFRESHED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    QUERIES_ADDED INTEGER DEFAULT 0 NOT NULL,
    QUERIES_REMOVED INTEGER DEFAULT 0 NOT NULL,
    QUERIES_UPDATED INTEGER DEFAULT 0 NOT NULL,
    QUERIES_UNCHANGED INTEGER DEFAULT 0 NOT NULL,
    REFRESH_STATUS VARCHAR(20) DEFAULT 'SUCCESS' NOT NULL,
    ERROR_MESSAGE VARCHAR(1000),
    CONSTRAINT FK_REFRESH_SET FOREIGN KEY (SET_ID) 
        REFERENCES QRYRUN_QUERY_SETS(SET_ID) ON DELETE CASCADE,
    CONSTRAINT FK_REFRESH_USER FOREIGN KEY (REFRESHED_BY) 
        REFERENCES QRYRUN_USERS(USER_ID),
    CONSTRAINT CHK_REFRESH_STATUS CHECK (REFRESH_STATUS IN ('SUCCESS', 'PARTIAL', 'FAILED'))
);

LABEL ON TABLE QRYRUN_SET_REFRESH_LOG IS 'Query Set Refresh History';
LABEL ON COLUMN QRYRUN_SET_REFRESH_LOG.REFRESH_ID IS 'Refresh ID';
LABEL ON COLUMN QRYRUN_SET_REFRESH_LOG.SET_ID IS 'Query Set ID';
LABEL ON COLUMN QRYRUN_SET_REFRESH_LOG.REFRESHED_BY IS 'User Who Refreshed';
LABEL ON COLUMN QRYRUN_SET_REFRESH_LOG.REFRESHED_AT IS 'Refresh Timestamp';
LABEL ON COLUMN QRYRUN_SET_REFRESH_LOG.QUERIES_ADDED IS 'Queries Added';
LABEL ON COLUMN QRYRUN_SET_REFRESH_LOG.QUERIES_REMOVED IS 'Queries Removed';
LABEL ON COLUMN QRYRUN_SET_REFRESH_LOG.QUERIES_UPDATED IS 'Queries Updated';
LABEL ON COLUMN QRYRUN_SET_REFRESH_LOG.QUERIES_UNCHANGED IS 'Queries Unchanged';
LABEL ON COLUMN QRYRUN_SET_REFRESH_LOG.REFRESH_STATUS IS 'Refresh Status';
LABEL ON COLUMN QRYRUN_SET_REFRESH_LOG.ERROR_MESSAGE IS 'Error Details';

CREATE INDEX REFRESH_SET_IDX ON QRYRUN_SET_REFRESH_LOG(SET_ID, REFRESHED_AT DESC);
```

### QRYRUN_TEST_RUNS
Stores test run configurations and metadata.

```sql
CREATE TABLE QRYRUN_TEST_RUNS (
    RUN_ID INTEGER NOT NULL GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    SET_ID INTEGER NOT NULL,
    RUN_NAME VARCHAR(100) NOT NULL,
    RUN_DESCRIPTION VARCHAR(500),
    ITERATION_COUNT INTEGER DEFAULT 1 NOT NULL,
    METRICS_LEVEL VARCHAR(20) DEFAULT 'STANDARD' NOT NULL,
    CREATED_BY VARCHAR(10) NOT NULL,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    STARTED_AT TIMESTAMP,
    COMPLETED_AT TIMESTAMP,
    STATUS VARCHAR(20) DEFAULT 'PENDING' NOT NULL,
    TOTAL_QUERIES INTEGER DEFAULT 0 NOT NULL,
    SUCCESSFUL_QUERIES INTEGER DEFAULT 0 NOT NULL,
    FAILED_QUERIES INTEGER DEFAULT 0 NOT NULL,
    TOTAL_EXECUTIONS INTEGER DEFAULT 0 NOT NULL,
    AVG_DURATION_MS DECIMAL(15,3),
    CONSTRAINT FK_RUN_SET FOREIGN KEY (SET_ID) 
        REFERENCES QRYRUN_QUERY_SETS(SET_ID),
    CONSTRAINT FK_RUN_USER FOREIGN KEY (CREATED_BY) 
        REFERENCES QRYRUN_USERS(USER_ID),
    CONSTRAINT CHK_RUN_STATUS CHECK (STATUS IN ('PENDING', 'RUNNING', 'COMPLETED', 'FAILED', 'CANCELLED')),
    CONSTRAINT CHK_RUN_METRICS CHECK (METRICS_LEVEL IN ('BASIC', 'STANDARD', 'COMPREHENSIVE')),
    CONSTRAINT CHK_RUN_ITERATIONS CHECK (ITERATION_COUNT > 0)
);

LABEL ON TABLE QRYRUN_TEST_RUNS IS 'Test Run Executions';
LABEL ON COLUMN QRYRUN_TEST_RUNS.RUN_ID IS 'Test Run ID';
LABEL ON COLUMN QRYRUN_TEST_RUNS.SET_ID IS 'Query Set ID';
LABEL ON COLUMN QRYRUN_TEST_RUNS.RUN_NAME IS 'Test Run Name';
LABEL ON COLUMN QRYRUN_TEST_RUNS.RUN_DESCRIPTION IS 'Description';
LABEL ON COLUMN QRYRUN_TEST_RUNS.ITERATION_COUNT IS 'Iterations Per Query';
LABEL ON COLUMN QRYRUN_TEST_RUNS.METRICS_LEVEL IS 'Metrics Detail Level';
LABEL ON COLUMN QRYRUN_TEST_RUNS.CREATED_BY IS 'Created By User';
LABEL ON COLUMN QRYRUN_TEST_RUNS.CREATED_AT IS 'Created Timestamp';
LABEL ON COLUMN QRYRUN_TEST_RUNS.STARTED_AT IS 'Execution Started';
LABEL ON COLUMN QRYRUN_TEST_RUNS.COMPLETED_AT IS 'Execution Completed';
LABEL ON COLUMN QRYRUN_TEST_RUNS.STATUS IS 'Run Status';
LABEL ON COLUMN QRYRUN_TEST_RUNS.TOTAL_QUERIES IS 'Total Queries';
LABEL ON COLUMN QRYRUN_TEST_RUNS.SUCCESSFUL_QUERIES IS 'Successful Queries';
LABEL ON COLUMN QRYRUN_TEST_RUNS.FAILED_QUERIES IS 'Failed Queries';
LABEL ON COLUMN QRYRUN_TEST_RUNS.TOTAL_EXECUTIONS IS 'Total Executions';
LABEL ON COLUMN QRYRUN_TEST_RUNS.AVG_DURATION_MS IS 'Average Duration (ms)';

CREATE INDEX RUN_SET_IDX ON QRYRUN_TEST_RUNS(SET_ID, CREATED_AT DESC);
CREATE INDEX RUN_STATUS_IDX ON QRYRUN_TEST_RUNS(STATUS, CREATED_AT DESC);
```

### QRYRUN_EXECUTIONS
Stores individual query execution results.

```sql
CREATE TABLE QRYRUN_EXECUTIONS (
    EXECUTION_ID BIGINT NOT NULL GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    RUN_ID INTEGER NOT NULL,
    QUERY_ID INTEGER NOT NULL,
    ITERATION_NUM INTEGER NOT NULL,
    START_TIME TIMESTAMP(6) NOT NULL,
    END_TIME TIMESTAMP(6),
    DURATION_MS DECIMAL(15,3),
    STATUS VARCHAR(20) DEFAULT 'RUNNING' NOT NULL,
    ERROR_MESSAGE VARCHAR(1000),
    ROWS_RETURNED BIGINT,
    ROWS_AFFECTED BIGINT,
    CONSTRAINT FK_EXEC_RUN FOREIGN KEY (RUN_ID) 
        REFERENCES QRYRUN_TEST_RUNS(RUN_ID) ON DELETE CASCADE,
    CONSTRAINT FK_EXEC_QUERY FOREIGN KEY (QUERY_ID) 
        REFERENCES QRYRUN_QUERIES(QUERY_ID),
    CONSTRAINT CHK_EXEC_STATUS CHECK (STATUS IN ('RUNNING', 'SUCCESS', 'FAILED', 'TIMEOUT'))
);

LABEL ON TABLE QRYRUN_EXECUTIONS IS 'Query Execution Results';
LABEL ON COLUMN QRYRUN_EXECUTIONS.EXECUTION_ID IS 'Execution ID';
LABEL ON COLUMN QRYRUN_EXECUTIONS.RUN_ID IS 'Test Run ID';
LABEL ON COLUMN QRYRUN_EXECUTIONS.QUERY_ID IS 'Query ID';
LABEL ON COLUMN QRYRUN_EXECUTIONS.ITERATION_NUM IS 'Iteration Number';
LABEL ON COLUMN QRYRUN_EXECUTIONS.START_TIME IS 'Start Time';
LABEL ON COLUMN QRYRUN_EXECUTIONS.END_TIME IS 'End Time';
LABEL ON COLUMN QRYRUN_EXECUTIONS.DURATION_MS IS 'Duration (ms)';
LABEL ON COLUMN QRYRUN_EXECUTIONS.STATUS IS 'Execution Status';
LABEL ON COLUMN QRYRUN_EXECUTIONS.ERROR_MESSAGE IS 'Error Details';
LABEL ON COLUMN QRYRUN_EXECUTIONS.ROWS_RETURNED IS 'Rows Returned';
LABEL ON COLUMN QRYRUN_EXECUTIONS.ROWS_AFFECTED IS 'Rows Affected';

CREATE INDEX EXEC_RUN_IDX ON QRYRUN_EXECUTIONS(RUN_ID, QUERY_ID, ITERATION_NUM);
CREATE INDEX EXEC_QUERY_IDX ON QRYRUN_EXECUTIONS(QUERY_ID, STATUS);
CREATE INDEX EXEC_TIME_IDX ON QRYRUN_EXECUTIONS(START_TIME);
```

### QRYRUN_METRICS
Stores detailed performance metrics (comprehensive mode).

```sql
CREATE TABLE QRYRUN_METRICS (
    METRIC_ID BIGINT NOT NULL GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    EXECUTION_ID BIGINT NOT NULL,
    CPU_TIME_MS DECIMAL(15,3),
    IO_OPERATIONS BIGINT,
    LOGICAL_READS BIGINT,
    PHYSICAL_READS BIGINT,
    TEMP_STORAGE_KB BIGINT,
    ESTIMATED_COST DECIMAL(15,2),
    ACTUAL_ROWS BIGINT,
    CONSTRAINT FK_METRIC_EXEC FOREIGN KEY (EXECUTION_ID) 
        REFERENCES QRYRUN_EXECUTIONS(EXECUTION_ID) ON DELETE CASCADE
);

LABEL ON TABLE QRYRUN_METRICS IS 'Detailed Performance Metrics';
LABEL ON COLUMN QRYRUN_METRICS.METRIC_ID IS 'Metric ID';
LABEL ON COLUMN QRYRUN_METRICS.EXECUTION_ID IS 'Execution ID';
LABEL ON COLUMN QRYRUN_METRICS.CPU_TIME_MS IS 'CPU Time (ms)';
LABEL ON COLUMN QRYRUN_METRICS.IO_OPERATIONS IS 'I/O Operations';
LABEL ON COLUMN QRYRUN_METRICS.LOGICAL_READS IS 'Logical Reads';
LABEL ON COLUMN QRYRUN_METRICS.PHYSICAL_READS IS 'Physical Reads';
LABEL ON COLUMN QRYRUN_METRICS.TEMP_STORAGE_KB IS 'Temp Storage (KB)';
LABEL ON COLUMN QRYRUN_METRICS.ESTIMATED_COST IS 'Estimated Cost';
LABEL ON COLUMN QRYRUN_METRICS.ACTUAL_ROWS IS 'Actual Rows';

CREATE INDEX METRIC_EXEC_IDX ON QRYRUN_METRICS(EXECUTION_ID);
```

### QRYRUN_COMPARISONS
Stores comparison analysis results.

```sql
CREATE TABLE QRYRUN_COMPARISONS (
    COMPARISON_ID INTEGER NOT NULL GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    BASELINE_RUN_ID INTEGER NOT NULL,
    COMPARISON_RUN_ID INTEGER NOT NULL,
    CREATED_BY VARCHAR(10) NOT NULL,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    DEVIATION_THRESHOLD DECIMAL(5,2) DEFAULT 20.00 NOT NULL,
    SET_LEVEL_CHANGE DECIMAL(8,2),
    QUERIES_ANALYZED INTEGER DEFAULT 0 NOT NULL,
    QUERIES_IMPROVED INTEGER DEFAULT 0 NOT NULL,
    QUERIES_DEGRADED INTEGER DEFAULT 0 NOT NULL,
    QUERIES_UNCHANGED INTEGER DEFAULT 0 NOT NULL,
    QUERIES_FAILED_BASELINE INTEGER DEFAULT 0 NOT NULL,
    QUERIES_FAILED_COMPARISON INTEGER DEFAULT 0 NOT NULL,
    CONSTRAINT FK_COMP_BASELINE FOREIGN KEY (BASELINE_RUN_ID) 
        REFERENCES QRYRUN_TEST_RUNS(RUN_ID),
    CONSTRAINT FK_COMP_COMPARISON FOREIGN KEY (COMPARISON_RUN_ID) 
        REFERENCES QRYRUN_TEST_RUNS(RUN_ID),
    CONSTRAINT FK_COMP_USER FOREIGN KEY (CREATED_BY) 
        REFERENCES QRYRUN_USERS(USER_ID),
    CONSTRAINT CHK_COMP_RUNS CHECK (BASELINE_RUN_ID <> COMPARISON_RUN_ID)
);

LABEL ON TABLE QRYRUN_COMPARISONS IS 'Test Run Comparisons';
LABEL ON COLUMN QRYRUN_COMPARISONS.COMPARISON_ID IS 'Comparison ID';
LABEL ON COLUMN QRYRUN_COMPARISONS.BASELINE_RUN_ID IS 'Baseline Run';
LABEL ON COLUMN QRYRUN_COMPARISONS.COMPARISON_RUN_ID IS 'Comparison Run';
LABEL ON COLUMN QRYRUN_COMPARISONS.CREATED_BY IS 'Created By User';
LABEL ON COLUMN QRYRUN_COMPARISONS.CREATED_AT IS 'Created Timestamp';
LABEL ON COLUMN QRYRUN_COMPARISONS.DEVIATION_THRESHOLD IS 'Threshold %';
LABEL ON COLUMN QRYRUN_COMPARISONS.SET_LEVEL_CHANGE IS 'Set Level Change %';
LABEL ON COLUMN QRYRUN_COMPARISONS.QUERIES_ANALYZED IS 'Queries Analyzed';
LABEL ON COLUMN QRYRUN_COMPARISONS.QUERIES_IMPROVED IS 'Queries Improved';
LABEL ON COLUMN QRYRUN_COMPARISONS.QUERIES_DEGRADED IS 'Queries Degraded';
LABEL ON COLUMN QRYRUN_COMPARISONS.QUERIES_UNCHANGED IS 'Queries Unchanged';
LABEL ON COLUMN QRYRUN_COMPARISONS.QUERIES_FAILED_BASELINE IS 'Baseline Failures';
LABEL ON COLUMN QRYRUN_COMPARISONS.QUERIES_FAILED_COMPARISON IS 'Comparison Failures';

CREATE INDEX COMP_RUNS_IDX ON QRYRUN_COMPARISONS(BASELINE_RUN_ID, COMPARISON_RUN_ID);
```

### QRYRUN_COMPARISON_DETAILS
Stores per-query comparison details.

```sql
CREATE TABLE QRYRUN_COMPARISON_DETAILS (
    DETAIL_ID BIGINT NOT NULL GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    COMPARISON_ID INTEGER NOT NULL,
    QUERY_ID INTEGER NOT NULL,
    BASELINE_AVG_MS DECIMAL(15,3),
    COMPARISON_AVG_MS DECIMAL(15,3),
    BASELINE_MIN_MS DECIMAL(15,3),
    COMPARISON_MIN_MS DECIMAL(15,3),
    BASELINE_MAX_MS DECIMAL(15,3),
    COMPARISON_MAX_MS DECIMAL(15,3),
    PERCENT_CHANGE DECIMAL(8,2),
    STATUS VARCHAR(20) NOT NULL,
    BASELINE_FAILURES INTEGER DEFAULT 0 NOT NULL,
    COMPARISON_FAILURES INTEGER DEFAULT 0 NOT NULL,
    CONSTRAINT FK_DETAIL_COMP FOREIGN KEY (COMPARISON_ID) 
        REFERENCES QRYRUN_COMPARISONS(COMPARISON_ID) ON DELETE CASCADE,
    CONSTRAINT FK_DETAIL_QUERY FOREIGN KEY (QUERY_ID) 
        REFERENCES QRYRUN_QUERIES(QUERY_ID),
    CONSTRAINT CHK_DETAIL_STATUS CHECK (STATUS IN ('IMPROVED', 'DEGRADED', 'UNCHANGED', 'FAILED', 'NEW_FAILURE', 'RESOLVED'))
);

LABEL ON TABLE QRYRUN_COMPARISON_DETAILS IS 'Query-Level Comparison Details';
LABEL ON COLUMN QRYRUN_COMPARISON_DETAILS.DETAIL_ID IS 'Detail ID';
LABEL ON COLUMN QRYRUN_COMPARISON_DETAILS.COMPARISON_ID IS 'Comparison ID';
LABEL ON COLUMN QRYRUN_COMPARISON_DETAILS.QUERY_ID IS 'Query ID';
LABEL ON COLUMN QRYRUN_COMPARISON_DETAILS.BASELINE_AVG_MS IS 'Baseline Avg (ms)';
LABEL ON COLUMN QRYRUN_COMPARISON_DETAILS.COMPARISON_AVG_MS IS 'Comparison Avg (ms)';
LABEL ON COLUMN QRYRUN_COMPARISON_DETAILS.BASELINE_MIN_MS IS 'Baseline Min (ms)';
LABEL ON COLUMN QRYRUN_COMPARISON_DETAILS.COMPARISON_MIN_MS IS 'Comparison Min (ms)';
LABEL ON COLUMN QRYRUN_COMPARISON_DETAILS.BASELINE_MAX_MS IS 'Baseline Max (ms)';
LABEL ON COLUMN QRYRUN_COMPARISON_DETAILS.COMPARISON_MAX_MS IS 'Comparison Max (ms)';
LABEL ON COLUMN QRYRUN_COMPARISON_DETAILS.PERCENT_CHANGE IS 'Percent Change';
LABEL ON COLUMN QRYRUN_COMPARISON_DETAILS.STATUS IS 'Comparison Status';
LABEL ON COLUMN QRYRUN_COMPARISON_DETAILS.BASELINE_FAILURES IS 'Baseline Failures';
LABEL ON COLUMN QRYRUN_COMPARISON_DETAILS.COMPARISON_FAILURES IS 'Comparison Failures';

CREATE INDEX DETAIL_COMP_IDX ON QRYRUN_COMPARISON_DETAILS(COMPARISON_ID, STATUS);
CREATE INDEX DETAIL_QUERY_IDX ON QRYRUN_COMPARISON_DETAILS(QUERY_ID);
```

## Useful Views

### V_QUERY_SET_SUMMARY
Summary view of query sets with statistics.

```sql
CREATE VIEW V_QUERY_SET_SUMMARY AS
SELECT 
    QS.SET_ID,
    QS.SET_NAME,
    QS.SET_DESCRIPTION,
    QS.SOURCE_USER_PROFILE,
    QS.CREATED_BY,
    QS.CREATED_AT,
    QS.LAST_REFRESHED,
    QS.IS_ACTIVE,
    QS.QUERY_COUNT,
    COUNT(DISTINCT TR.RUN_ID) AS TOTAL_RUNS,
    MAX(TR.COMPLETED_AT) AS LAST_RUN_DATE
FROM QRYRUN_QUERY_SETS QS
LEFT JOIN QRYRUN_TEST_RUNS TR ON QS.SET_ID = TR.SET_ID
GROUP BY 
    QS.SET_ID, QS.SET_NAME, QS.SET_DESCRIPTION, 
    QS.SOURCE_USER_PROFILE, QS.CREATED_BY, QS.CREATED_AT,
    QS.LAST_REFRESHED, QS.IS_ACTIVE, QS.QUERY_COUNT;
```

### V_TEST_RUN_SUMMARY
Summary view of test runs with execution statistics.

```sql
CREATE VIEW V_TEST_RUN_SUMMARY AS
SELECT 
    TR.RUN_ID,
    TR.RUN_NAME,
    TR.SET_ID,
    QS.SET_NAME,
    TR.STATUS,
    TR.CREATED_BY,
    TR.CREATED_AT,
    TR.STARTED_AT,
    TR.COMPLETED_AT,
    TR.ITERATION_COUNT,
    TR.METRICS_LEVEL,
    TR.TOTAL_QUERIES,
    TR.SUCCESSFUL_QUERIES,
    TR.FAILED_QUERIES,
    TR.TOTAL_EXECUTIONS,
    TR.AVG_DURATION_MS,
    CASE 
        WHEN TR.COMPLETED_AT IS NOT NULL AND TR.STARTED_AT IS NOT NULL
        THEN TIMESTAMPDIFF(2, CHAR(TR.COMPLETED_AT - TR.STARTED_AT))
        ELSE NULL
    END AS TOTAL_RUNTIME_SECONDS
FROM QRYRUN_TEST_RUNS TR
JOIN QRYRUN_QUERY_SETS QS ON TR.SET_ID = QS.SET_ID;
```

### V_QUERY_EXECUTION_STATS
Aggregated execution statistics per query.

```sql
CREATE VIEW V_QUERY_EXECUTION_STATS AS
SELECT 
    E.QUERY_ID,
    E.RUN_ID,
    Q.QUERY_NAME,
    Q.SET_ID,
    COUNT(*) AS EXECUTION_COUNT,
    AVG(E.DURATION_MS) AS AVG_DURATION_MS,
    MIN(E.DURATION_MS) AS MIN_DURATION_MS,
    MAX(E.DURATION_MS) AS MAX_DURATION_MS,
    STDDEV(E.DURATION_MS) AS STDDEV_DURATION_MS,
    SUM(CASE WHEN E.STATUS = 'SUCCESS' THEN 1 ELSE 0 END) AS SUCCESS_COUNT,
    SUM(CASE WHEN E.STATUS = 'FAILED' THEN 1 ELSE 0 END) AS FAILURE_COUNT,
    SUM(E.ROWS_RETURNED) AS TOTAL_ROWS_RETURNED,
    SUM(E.ROWS_AFFECTED) AS TOTAL_ROWS_AFFECTED
FROM QRYRUN_EXECUTIONS E
JOIN QRYRUN_QUERIES Q ON E.QUERY_ID = Q.QUERY_ID
WHERE E.STATUS IN ('SUCCESS', 'FAILED')
GROUP BY E.QUERY_ID, E.RUN_ID, Q.QUERY_NAME, Q.SET_ID;
```

## Stored Procedures

### SP_CALCULATE_RUN_STATISTICS
Calculate and update test run statistics.

```sql
CREATE PROCEDURE SP_CALCULATE_RUN_STATISTICS (
    IN P_RUN_ID INTEGER
)
LANGUAGE SQL
BEGIN
    DECLARE V_TOTAL_QUERIES INTEGER;
    DECLARE V_SUCCESSFUL_QUERIES INTEGER;
    DECLARE V_FAILED_QUERIES INTEGER;
    DECLARE V_TOTAL_EXECUTIONS INTEGER;
    DECLARE V_AVG_DURATION DECIMAL(15,3);
    
    -- Calculate statistics from executions
    SELECT 
        COUNT(DISTINCT QUERY_ID),
        SUM(CASE WHEN STATUS = 'SUCCESS' THEN 1 ELSE 0 END),
        SUM(CASE WHEN STATUS = 'FAILED' THEN 1 ELSE 0 END),
        COUNT(*),
        AVG(DURATION_MS)
    INTO 
        V_TOTAL_QUERIES,
        V_SUCCESSFUL_QUERIES,
        V_FAILED_QUERIES,
        V_TOTAL_EXECUTIONS,
        V_AVG_DURATION
    FROM QRYRUN_EXECUTIONS
    WHERE RUN_ID = P_RUN_ID
        AND STATUS IN ('SUCCESS', 'FAILED');
    
    -- Update test run record
    UPDATE QRYRUN_TEST_RUNS
    SET 
        TOTAL_QUERIES = V_TOTAL_QUERIES,
        SUCCESSFUL_QUERIES = V_SUCCESSFUL_QUERIES,
        FAILED_QUERIES = V_FAILED_QUERIES,
        TOTAL_EXECUTIONS = V_TOTAL_EXECUTIONS,
        AVG_DURATION_MS = V_AVG_DURATION
    WHERE RUN_ID = P_RUN_ID;
END;
```

## Configuration Table

### QRYRUN_CONFIG
Application configuration settings.

```sql
CREATE TABLE QRYRUN_CONFIG (
    CONFIG_KEY VARCHAR(50) NOT NULL PRIMARY KEY,
    CONFIG_VALUE VARCHAR(1000),
    CONFIG_TYPE VARCHAR(20) NOT NULL,
    DESCRIPTION VARCHAR(500),
    UPDATED_BY VARCHAR(10),
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT FK_CONFIG_USER FOREIGN KEY (UPDATED_BY) 
        REFERENCES QRYRUN_USERS(USER_ID),
    CONSTRAINT CHK_CONFIG_TYPE CHECK (CONFIG_TYPE IN ('STRING', 'NUMBER', 'BOOLEAN', 'JSON'))
);

LABEL ON TABLE QRYRUN_CONFIG IS 'Application Configuration';
LABEL ON COLUMN QRYRUN_CONFIG.CONFIG_KEY IS 'Configuration Key';
LABEL ON COLUMN QRYRUN_CONFIG.CONFIG_VALUE IS 'Configuration Value';
LABEL ON COLUMN QRYRUN_CONFIG.CONFIG_TYPE IS 'Value Type';
LABEL ON COLUMN QRYRUN_CONFIG.DESCRIPTION IS 'Description';
LABEL ON COLUMN QRYRUN_CONFIG.UPDATED_BY IS 'Last Updated By';
LABEL ON COLUMN QRYRUN_CONFIG.UPDATED_AT IS 'Last Updated';

-- Default configuration values
INSERT INTO QRYRUN_CONFIG (CONFIG_KEY, CONFIG_VALUE, CONFIG_TYPE, DESCRIPTION) VALUES
('DEFAULT_DEVIATION_THRESHOLD', '20.00', 'NUMBER', 'Default percentage threshold for deviation detection'),
('DEFAULT_METRICS_LEVEL', 'STANDARD', 'STRING', 'Default metrics collection level'),
('MAX_ITERATION_COUNT', '100', 'NUMBER', 'Maximum iterations allowed per query'),
('QUERY_TIMEOUT_SECONDS', '300', 'NUMBER', 'Query execution timeout in seconds'),
('ENABLE_PARALLEL_EXECUTION', 'false', 'BOOLEAN', 'Enable parallel query execution'),
('MAX_PARALLEL_QUERIES', '5', 'NUMBER', 'Maximum queries to execute in parallel');
```

## Indexes Summary

All critical indexes have been created inline with table definitions:

1. **User lookups**: `USERS_LOGIN_IDX`
2. **Query set filtering**: `QSET_ACTIVE_IDX`, `QSET_USER_IDX`
3. **Query lookups**: `QUERY_SET_IDX`, `QUERY_HASH_IDX`, `QUERY_CACHE_KEY_IDX`
4. **Refresh history**: `REFRESH_SET_IDX`
5. **Test run filtering**: `RUN_SET_IDX`, `RUN_STATUS_IDX`
6. **Execution queries**: `EXEC_RUN_IDX`, `EXEC_QUERY_IDX`, `EXEC_TIME_IDX`
7. **Metrics lookup**: `METRIC_EXEC_IDX`
8. **Comparison queries**: `COMP_RUNS_IDX`, `DETAIL_COMP_IDX`, `DETAIL_QUERY_IDX`

## Complete Deployment Script

Here's a complete script to deploy the schema to any library:

```sql
-- Step 1: Set your library/schema
SET SCHEMA YOURLIB;

-- Step 2: Create all tables (in dependency order)
-- Run all CREATE TABLE statements above in order

-- Step 3: Create views
-- Run all CREATE VIEW statements above

-- Step 4: Create stored procedures
-- Run all CREATE PROCEDURE statements above

-- Step 5: Insert initial data
INSERT INTO QRYRUN_USERS (USER_ID, USER_NAME, IS_ADMIN)
VALUES ('QSECOFR', 'Security Officer', 'Y');

INSERT INTO QRYRUN_CONFIG (CONFIG_KEY, CONFIG_VALUE, CONFIG_TYPE, DESCRIPTION) VALUES
('DEFAULT_DEVIATION_THRESHOLD', '20.00', 'NUMBER', 'Default percentage threshold for deviation detection'),
('DEFAULT_METRICS_LEVEL', 'STANDARD', 'STRING', 'Default metrics collection level'),
('MAX_ITERATION_COUNT', '100', 'NUMBER', 'Maximum iterations allowed per query'),
('QUERY_TIMEOUT_SECONDS', '300', 'NUMBER', 'Query execution timeout in seconds'),
('ENABLE_PARALLEL_EXECUTION', 'false', 'BOOLEAN', 'Enable parallel query execution'),
('MAX_PARALLEL_QUERIES', '5', 'NUMBER', 'Maximum queries to execute in parallel');

-- Step 6: Grant authorities
-- Grant appropriate authorities to application user profile
-- Example: GRTOBJAUT OBJ(YOURLIB/*ALL) OBJTYPE(*FILE) USER(APPUSER) AUT(*ALL)
```

## Data Retention Policy

Consider implementing these policies:

1. **Execution Data**: Retain for 90 days, then archive or purge
2. **Comparison Data**: Retain for 180 days
3. **Refresh Logs**: Retain for 30 days
4. **Inactive Query Sets**: Archive after 1 year of no activity

## Backup Recommendations

1. Daily backup of all tables
2. Transaction log backup every 4 hours
3. Monthly full backup with long-term retention
4. Test restore procedures quarterly

## Application Configuration

The application will need to know the library name. This should be configured in the Node.js application's environment variables or configuration file:

```javascript
// Example configuration
const config = {
  database: {
    library: process.env.DB_LIBRARY || 'QRYRUNLIB',
    host: process.env.DB_HOST,
    user: process.env.DB_USER,
    password: process.env.DB_PASSWORD
  }
};
```

The application will then use this library name when constructing SQL queries:

```javascript
const tableName = `${config.database.library}.QRYRUN_USERS`;